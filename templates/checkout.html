{% extends 'header.html' %}
{% load static %}
{% block content %}

<style>
  .tab__body {
  padding: 1rem;
  background-color: #f9f9f9;
  border-radius: 8px;
}

.address__option {
  display: flex;
  align-items: flex-start;
  margin-bottom: 1rem;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 1rem;
  transition: all 0.3s ease;
}

.address__option:hover {
  background-color: #f1f1f1;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.payment__input {
  margin-right: 1rem;
  transform: scale(1.2);
  cursor: pointer;
}

.address__label {
  cursor: pointer;
  width: 100%;
}

.address__content {
  display: flex;
  flex-direction: column;
}

.address__name {
  font-size: 1.2rem;
  font-weight: bold;
  color: #333;
  margin-bottom: 0.5rem;
}

.address__details {
  font-size: 0.9rem;
  color: #666;
  line-height: 1.5;
}

.no-address-message {
  color: #999;
  font-style: italic;
  text-align: center;
  margin-top: 1rem;
}
<style>
  .dropdown__content {
    position: absolute;
    top: -250%; /* Position above the address options */
    left: 0;
    width: 100%; /* Smaller width */
    background: white;
    padding: 0.8rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    border-radius: 5px;
    z-index: 100;
  }

  .address__dropdown {
    position: relative;
  }

  .form__input {
    width: 100%;
    padding: 0.4rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 0.9rem;
  }

  .form__label {
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 0.3rem;
  }
</style>
<style>
  
.coupon__list-container {
  width: 100%;
  max-width: 450px;
  margin: 0 auto;
  padding: 6px;
  border-radius: 4px;
  overflow: hidden;
}

.coupon__list {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding: 2px;
  scrollbar-width: thin;
  -webkit-overflow-scrolling: touch;
  scroll-behavior: smooth;
  list-style: none;
  margin: 0;
  overflow-y: hidden;
  padding-left: 0;
  width: 100%;
}

.coupon__list::-webkit-scrollbar {
  height: 2px;
}

.coupon__list::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.coupon__list::-webkit-scrollbar-thumb {
  background: #888;
}

/* Modern Design - Option 1 */

/* Modern Design - Option 3 */
.design-3 .coupon__item {
  flex: 0 0 120px;
  height: 60px;
  padding: 4px 6px;
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border-radius: 6px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.design-3 .coupon__code {
  background: #0ea5e9;
  color: white;
  border-radius: 3px;
  padding: 2px 4px;
  font-size: 0.65rem;
}

.design-3 .coupon__discount {
  color: #0369a1;
  font-weight: 700;
}
.minimum_puchase{
  color: black;
}

@media (max-width: 768px) {
  .coupon__list-container {
    width: 80%;
    padding: 4px;
  }
  
  [class*="design-"] .coupon__item {
    flex: 0 0 100px;
    height: 50px;
    padding: 3px 4px;
  }
}
/* Styles for Apply Coupon Section (Compact Size) */
.apply-coupon {
  padding: 0.3rem;
  margin: 0.3rem 0;
  border: 1px solid #ddd;
  border-radius: 4px;
  background-color: #f9f9f9;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.apply-coupon h3.section__title {
  font-size: 1rem; /* Smaller font size */
  font-weight: bold;
  margin-bottom: 0.3rem;
  color: #333;
}

.coupon__form {
  display: flex;
  align-items: center;
  gap: 0.2rem; /* Minimal spacing */
}

.coupon__input-group {
  display: flex;
  flex: 1;
}

.coupon__input,
.coupon__btn,.remove-btn {
  height: 2.4rem; /* Set both elements to the same height */
  padding: 0 0.5rem; /* Horizontal padding */
  font-size: 0.8rem; /* Reduced font size */
  border-radius: 4px;
  display: flex;
  align-items: center; /* Center content vertically */
}

.coupon__input {
  flex: 1;
  border: 1px solid #ccc;
  outline: none;
}

.coupon__input:focus {
  border-color: hsl(176, 88%, 27%);
  box-shadow: 0 0 2px hsl(176, 88%, 70%);
}

.coupon__btn {
  background-color: hsl(176, 88%, 27%);
  color: white;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s;
}
.remove-btn {
  background-color: #FF4C4C;
  color: white;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s;
}


.coupon__btn:hover {
  background-color: hsl(176, 88%, 35%);
}

.coupon__message {
  margin-top: 0.3rem; /* Minimal margin */
  font-size: 0.7rem; /* Smaller font size */
  padding: 0.2rem; /* Smaller padding */
  border-radius: 4px;
}

.coupon__message.success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.coupon__message.error {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.minimum_purchase {
  margin: 0;
  color: #0369a1;
  font-weight: 500;
}
.original-price {
    text-decoration: line-through;
    color: #999;  /* Optional: to give the original price a grey color */
    margin-right: 10px;  /* Optional: space between original and discounted prices */
}

.discounted-price {
    color:  hsl(176, 88%, 35%);  /* Optional: use a color to highlight the discounted price */
    font-weight: bold;
}

</style>

</style>
    <!--=============== MAIN ===============-->
    <main class="main">
      <!--=============== BREADCRUMB ===============-->
      <section class="breadcrumb">
        <ul class="breadcrumb__list flex container">
          <li><a href="{% url 'index' %}" class="breadcrumb__link">Home</a></li>
          <li><span class="breadcrumb__link">></span></li>
          <li><a href="{% url 'display_products' %}"><span class="breadcrumb__link">Shop</span></a></li>
          <li><span class="breadcrumb__link">></span></li>
          <li><span class="breadcrumb__link">Checkout</span></li>
        </ul>
      </section>

      <!--=============== CHECKOUT ===============-->
      <section class="checkout section--lg">
        <div class="checkout__container container grid">
          
          <div class="checkout__group">
            <div class="address__dropdown">
              <button 
                  class="btn btn__primary" 
                  style="padding: 0.4rem 0.8rem; font-size: 0.9rem; background-color: hsl(176, 88%, 27%); color: white; border: none; border-radius: 5px; cursor: pointer;" 
                  id="toggleDropdownButton">
                  Add Address
              </button>
            
              <div class="dropdown__content" 
              id="dropdownContent" 
              style="display: {% if formdata.dropdown_open %}block{% else %}none{% endif %};">                 
               <form action="{% url 'add_address_checkout' %}" method="POST" style="padding: 0.8rem;">
                      {% csrf_token %}
                      <div class="form__group" style="margin-bottom: 0.8rem;">
                          <label for="add_fullname" class="form__label">Full Name</label>
                          <input type="text" id="add_fullname" name="fullname" class="form__input"  value="{{formdata.fullname}}"    required>
                      </div>
                      <div class="form__group" style="margin-bottom: 0.8rem;">
                          <label for="add_city" class="form__label">City</label>
                          <input type="text" id="add_city" name="city" class="form__input" value="{{formdata.city}}" required>
                      </div>
                      <div class="form__group" style="margin-bottom: 0.8rem;">
                          <label for="add_state" class="form__label">State</label>
                          <input type="text" id="add_state" name="state" class="form__input" value="{{formdata.state}}"   required>
                      </div>
                      <div class="form__group" style="margin-bottom: 0.8rem;">
                          <label for="add_postal_code" class="form__label">Postal Code</label>
                          <input type="text" id="add_postal_code" name="postalcode" class="form__input" value="{{formdata.postal_code}}"  required>
                      </div>
                      <div class="form__group" style="margin-bottom: 0.8rem;">
                          <label for="add_landmark" class="form__label">Landmark</label>
                          <input type="text" id="add_landmark" name="landmark" value="{{formdata.landmark}}"  class="form__input">
                      </div>
                      <div class="form__group" style="margin-bottom: 0.8rem;">
                          <label for="add_phone_number" class="form__label">Phone Number</label>
                          <input type="text" id="add_phone_number" name="phonenumber" class="form__input"  value="{{formdata.phonenumber}}"  required>
                      </div>
                      {% if formdata.error %}
                      <p  style="color: red;" >{{formdata.error}}</p>
                      {% endif %}
                      <div class="dropdown__actions" style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                          <button type="button" id="cancelAddButton" class="btn btn__cancel" style="background-color: #ccc; padding: 0.4rem 0.8rem; border: none; border-radius: 5px; font-size: 0.8rem;">Cancel</button>
                          <button type="submit" class="btn btn__primary" style="background-color: hsl(176, 88%, 27%); color: white; padding: 0.4rem 0.8rem; border: none; border-radius: 5px; font-size: 0.8rem;">Save</button>
                      </div>
                  </form>
              </div>
            </div>
            
            
            <div class="tab__body">
              
              {% if address %}
                {% for val in address %}
                  <div class="address__option">
                    <input
                      type="radio"
                      name="selected_address"
                      id="address_{{ forloop.counter }}"
                      class="payment__input"
                      value="{{ val.id }}"
                    />
                    <label for="address_{{ forloop.counter }}" class="address__label">
                      <div class="address__content">
                        <h4 class="address__name">{{ val.fullname }}</h4>
                        <p class="address__details">
                          {{ val.city }}, {{ val.state }} <br />
                          Postal Code: {{ val.postal_code }}<br />
                          Landmark: {{ val.landmark }}<br />
                          Phone: {{ val.phone_number }}
                        </p>
                      </div>
                    </label>
                  </div>
                {% endfor %}
              {% else %}
                <p class="no-address-message">No addresses available. Please add one!</p>
              {% endif %}
              {% if error %}
              <div class="error-message">
              <p>{{ error }}</p>
              </div>
              {% endif %}

            </div>
           
          </div>
          
          
          <div class="checkout__group">
            <h3 class="section__title">Cart Totals</h3>
            <table class="order__table">
              <thead>
                <tr>
                  <th colspan="2">Products</th>
                  <th>Total</th>
                </tr>
              </thead>

              <tbody>
               
              {% if items %}
              {% for item in items %}
                <tr>
                  <td>
                    <img
                      src="{{item.product.image1.url}}"
                      alt=""
                      class="order__img"
                    />
                  </td>
                  <td>
                    <h3 class="table__title">{{item.product.name}}<alikutti/h3>
                    <p class="table__quantity">x {{item.quantity}}</p>
                  </td>
                  <td>
                    <span class="table__price original-price">${{ item.product.price }}</span>
                    <span class="table__price discounted-price">${{ item.product.offer }}</span>
                </td>
                

                </tr>
              
                {% endfor %}
                <tr>
                  <td><span class="order__subtitle">Subtotal</span></td>
                  <td colspan="2"><span class="table__price">{{sub_total|floatformat:-0 }}</span></td>
                </tr>
                {% if coupon_discount %}
                <tr>
                  <td><span class="order__subtitle">Coupon discount</span></td>
                  <td colspan="2"><span class="table__price">-{{coupon_discount|floatformat:-0 }}</span></td>
                </tr>
                {% endif %}
                <tr>
                  <td><span class="order__subtitle">Total Discount</span></td>
                  <td colspan="2"><span class="table__price">-{{total_discount|floatformat:-0 }}</span></td>
                </tr>
                
                <tr>
                  <td><span class="order__subtitle">Shipping</span></td>
                  <td colspan="2">
                    <span class="table__price">150</span>
                  </td>
                </tr>
                <tr>
                  <td><span class="order__subtitle">Total</span></td>
                  <td colspan="2">
                    {% if cart_item %}
                    <span class="order__grand-total">₹{{ cart_item|floatformat:-0  }}</span>
                    {% endif %}
                  </td>

                </tr>
                {% endif %}
              </tbody>
            </table>
          
            
            <div class="coupon__section">
              <h3 class="section__title">Available Coupons</h3>
              
              <!-- Coupons with horizontal overflow -->
              <div class="coupon__list-container design-3">
                <ul class="coupon__list">
                  {% if coupons %}
                    {% for coupon in coupons %}
                      <li class="coupon__item">
                        <div class="coupon__top">
                          <h4 class="coupon__code">{{ coupon.code }}</h4>
                          <span class="coupon__discount">{{ coupon.discount_value }}%</span>
                        </div>
                        <p class="minimum_purchase">Min: ₹{{ coupon.min_purchase_amount|floatformat:0 }}</p>
                        <p class="coupon__validity">
                          {% if coupon.valid_to %}
                            Valid till: {{ coupon.valid_to }}
                          {% else %}
                            No expiry date
                          {% endif %}
                        </p>
                      </li>
                    {% endfor %}
                  {% else %}
                    <p class="no-coupons">No coupons available</p>
                  {% endif %}
                </ul>
              </div>
              
            
              <!-- Coupon code input section -->
              <div class="apply-coupon">
                <h3 class="section__title">Apply Coupon</h3>
                <form action="{% url 'apply_coupon'  %}" method="POST" class="coupon__form">
                  {% csrf_token %}
                  <div class="coupon__input-group">
                    <input 
                      value="{{applied_coupon}}"
                      type="text" 
                      name="coupon_code" 
                      id="coupon_code" 
                      class="coupon__input" 
                      placeholder="Enter code"
                    />
                    <button type="submit" class="coupon__btn">Apply</button>
                    
                  </form>
                  <form action="{% url 'remove_coupon' %}" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="remove-btn">Remove</button>
                  
                  </div>
                </form>
                {% if coupon_message %}
                  <div class="coupon__message {{ coupon_message_class }}">
                    <p>{{ coupon_message }}</p>
                  </div>
                {% endif %}
              </div>
            </div>
            
            
            <div class="payment__methods">
              <h3 class="checkout__title payment__title">Payment</h3>
             
              <div class="payment__option flex">
                <input
                  type="radio"
                  name="radio"
                  id="cash_on_delivery"
                  class="payment__input"
                />
                <label for="l2" class="payment__label">Cash on Delivery</label>
              </div>
              <div class="payment__option flex">
                <input
                  type="radio"
                  name="radio"
                  id="razorpay"
                  class="payment__input"
                />
                <label for="" class="payment__label">Razorpay</label>
              </div>
            </div>
            <form action="{% url 'placeorder' %}" method="POST">
              {% csrf_token %}
              <input type="hidden" id="selected_address_id" name="selected_address_id">
              <input type="hidden" id="payment_type" name="payment_type">
              <button class="btn btn--md" type="submit">Place Order</button>
             
            </form>
            
            


          
          </div>
        </div>
      </section>

      <!--=============== NEWSLETTER ===============-->
      <section class="newsletter section">
        <div class="newsletter__container container grid">
          <h3 class="newsletter__title flex">
            <img
              src="./assets/img/icon-email.svg"
              alt=""
              class="newsletter__icon"
            />
            Sign in to Newsletter
          </h3>
          <p class="newsletter__description">
            ...and receive $25 coupon for first shopping.
          </p>
          <form action="" class="newsletter__form">
            <input
              type="text"
              placeholder="Enter Your Email"
              class="newsletter__input"
            />
            <button type="submit" class="newsletter__btn">Subscribe</button>
          </form>
        </div>
      </section>
    </main>
    <script>
      // When an address radio button is selected, update the hidden input for the selected address
      document.querySelectorAll('input[name="selected_address"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
          // Update the hidden input with the selected address ID
          document.getElementById('selected_address_id').value = this.value;
        });
      });
    
      // When a payment radio button is selected, update the hidden input for the payment type
      document.querySelectorAll('input[name="radio"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
          // Update the hidden input with the selected payment method ID (like l1, l2, or l3)
          document.getElementById('payment_type').value = this.id;
        });
      });
    </script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const toggleDropdownButton = document.getElementById('toggleDropdownButton');
    const dropdownContent = document.getElementById('dropdownContent');
    const cancelAddButton = document.getElementById('cancelAddButton');
    const form = dropdownContent.querySelector('form');

    // Toggle the dropdown
    toggleDropdownButton.addEventListener('click', () => {
        const isVisible = dropdownContent.style.display === 'block';
        dropdownContent.style.display = isVisible ? 'none' : 'block';
    });

    // Hide the dropdown on cancel
    cancelAddButton.addEventListener('click', () => {
        dropdownContent.style.display = 'none';
    });

    // Prevent the dropdown from closing automatically after submission
    form.addEventListener('submit', (event) => {
        // Do not hide the dropdown after the form is submitted
        // dropdownContent.style.display = 'block'; // This line is unnecessary
    });

    // Close the dropdown if clicked outside
    window.addEventListener('click', (event) => {
        if (
            !event.target.closest('.address__dropdown') &&
            !event.target.closest('#toggleDropdownButton')
        ) {
            dropdownContent.style.display = 'none';
        }
    });
});


</script>

    
    
    {% if messages %}
    <script>
        {% for message in messages %}
            {% if message.tags == 'error' %}
                Swal.fire({
                    icon: 'error',  // Error icon
                    title: 'Oops...',
                    text: '{{ message }}',
                    confirmButtonText: 'OK'
                });
            {% elif message.tags == 'success' %}
                Swal.fire({
                    icon: 'success',  // Success icon
                    title: 'Success!',
                    text: '{{ message }}',
                    confirmButtonText: 'OK'
                });
            {% endif %}
        {% endfor %}
    </script>
    {% endif %}
   {% endblock  %}